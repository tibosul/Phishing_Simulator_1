<!-- ===========================================
     TEMPLATE: admin/upload_targets.html
     =========================================== -->
{% extends "admin/base.html" %}

{% block title %}Upload Targets{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{{ url_for('targets.list_targets') }}">Targets</a></li>
<li class="breadcrumb-item active">Upload Targets</li>
{% endblock %}

{% block extra_head %}
<style>
.upload-zone {
    border: 2px dashed #007bff;
    border-radius: 10px;
    padding: 2rem;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
}
.upload-zone:hover {
    border-color: #0056b3;
    background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
}
.upload-zone.dragover {
    border-color: #28a745;
    background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c9 100%);
}
.upload-zone.error {
    border-color: #dc3545;
    background: linear-gradient(135deg, #ffeaea 0%, #ffcdd2 100%);
}
.file-info {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 1rem;
    margin: 1rem 0;
}
.preview-table {
    max-height: 400px;
    overflow-y: auto;
    border: 1px solid #dee2e6;
    border-radius: 8px;
}
.mapping-section {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 1.5rem;
    margin: 1rem 0;
}
.field-mapping {
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 6px;
    padding: 0.75rem;
    margin-bottom: 0.75rem;
}
.validation-error {
    background: #fff5f5;
    border: 1px solid #fed7d7;
    color: #c53030;
    padding: 0.5rem;
    border-radius: 4px;
    font-size: 0.875rem;
}
.validation-warning {
    background: #fffbf0;
    border: 1px solid #fed7aa;
    color: #c05621;
    padding: 0.5rem;
    border-radius: 4px;
    font-size: 0.875rem;
}
.step-indicator {
    display: flex;
    justify-content: center;
    margin-bottom: 2rem;
}
.step {
    display: flex;
    align-items: center;
    padding: 0.5rem 1rem;
    margin: 0 0.5rem;
    border-radius: 20px;
    background: #e9ecef;
    color: #6c757d;
    font-weight: 500;
}
.step.active {
    background: #007bff;
    color: white;
}
.step.completed {
    background: #28a745;
    color: white;
}
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-10 mx-auto">
        <!-- Step Indicator -->
        <div class="step-indicator">
            <div class="step active" id="step1">
                <i class="bi bi-upload me-2"></i>1. Upload File
            </div>
            <div class="step" id="step2">
                <i class="bi bi-arrow-left-right me-2"></i>2. Map Fields
            </div>
            <div class="step" id="step3">
                <i class="bi bi-check-circle me-2"></i>3. Validate & Import
            </div>
        </div>

        <div class="card shadow">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="bi bi-cloud-upload me-2"></i>Bulk Upload Targets from CSV
                </h6>
            </div>
            <div class="card-body">
                <!-- Step 1: File Upload -->
                <div id="uploadStep" class="step-content">
                    <form id="uploadForm" enctype="multipart/form-data">
                        <!-- Campaign Selection -->
                        <div class="mb-4">
                            <label for="campaign_id" class="form-label fw-bold">
                                Select Campaign <span class="text-danger">*</span>
                            </label>
                            <!-- DEBUG: campaigns variable = {{ campaigns|length if campaigns else 'NONE' }} -->
                            {% if not campaigns %}
                            <!-- No campaigns available -->
                            <div class="alert alert-warning" role="alert">
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                <strong>No campaigns available!</strong>
                                <p class="mb-2">You need to create at least one campaign before uploading targets.</p>
                                <a href="{{ url_for('campaigns.create_campaign') }}" class="btn btn-primary btn-sm">
                                    <i class="bi bi-plus-circle me-1"></i>Create Your First Campaign
                                </a>
                            </div>
                            <select class="form-select form-select-lg" id="campaign_id" name="campaign_id" required disabled>
                                <option value="">No campaigns available</option>
                            </select>
                            {% elif selected_campaign %}
                            <!-- When uploading to a specific campaign, show it as selected and readonly -->
                            <select class="form-select form-select-lg" id="campaign_id" name="campaign_id" required>
                                <option value="{{ selected_campaign.id }}" selected>
                                    {{ selected_campaign.name }} ({{ selected_campaign.type|title }} - {{ selected_campaign.status|title }})
                                </option>
                                {% for campaign in campaigns %}
                                {% if campaign.id != selected_campaign.id %}
                                <option value="{{ campaign.id }}" 
                                        data-type="{{ campaign.type }}" 
                                        data-status="{{ campaign.status }}">
                                    {{ campaign.name }} ({{ campaign.type|title }} - {{ campaign.status|title }})
                                </option>
                                {% endif %}
                                {% endfor %}
                            </select>
                            <div class="form-text">
                                {% if campaign %}
                                Uploading targets to campaign: <strong>{{ selected_campaign.name }}</strong>
                                {% else %}
                                Select the campaign these targets will be associated with
                                {% endif %}
                            </div>
                            {% else %}
                            <!-- When no specific campaign is selected, show all campaigns -->
                            <select class="form-select form-select-lg" id="campaign_id" name="campaign_id" required>
                                <option value="">Choose a campaign...</option>
                                {% for campaign in campaigns %}
                                <option value="{{ campaign.id }}" 
                                        data-type="{{ campaign.type }}" 
                                        data-status="{{ campaign.status }}">
                                    {{ campaign.name }} ({{ campaign.type|title }} - {{ campaign.status|title }})
                                </option>
                                {% endfor %}
                            </select>
                            <div class="form-text">Select the campaign these targets will be associated with</div>
                            {% endif %}
                        </div>

                        <!-- File Upload Zone -->
                        <div class="upload-zone{% if not campaigns %} error{% endif %}" id="uploadZone" 
                             {% if campaigns %}onclick="document.getElementById('csvFile').click()"{% endif %}>
                            <div id="uploadContent">
                                {% if campaigns %}
                                <i class="bi bi-cloud-upload" style="font-size: 3rem; color: #007bff;"></i>
                                <h5 class="mt-3">Drop your CSV file here</h5>
                                <p class="text-muted">or click to browse files</p>
                                <p class="small text-muted">
                                    Supported formats: .csv, .txt<br>
                                    Maximum file size: 10MB
                                </p>
                                {% else %}
                                <i class="bi bi-exclamation-triangle" style="font-size: 3rem; color: #dc3545;"></i>
                                <h5 class="mt-3 text-danger">Upload Disabled</h5>
                                <p class="text-muted">Create a campaign first to upload targets</p>
                                {% endif %}
                            </div>
                            <input type="file" id="csvFile" name="csv_file" accept=".csv,.txt" style="display: none;" {% if not campaigns %}disabled{% endif %}>
                        </div>

                        <!-- File Information -->
                        <div id="fileInfo" class="file-info" style="display: none;">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1"><i class="bi bi-file-earmark-text me-2"></i><span id="fileName"></span></h6>
                                    <small class="text-muted">
                                        Size: <span id="fileSize"></span> | 
                                        Rows: <span id="rowCount"></span> | 
                                        Columns: <span id="columnCount"></span>
                                    </small>
                                </div>
                                <button type="button" class="btn btn-sm btn-outline-danger" onclick="clearFile()">
                                    <i class="bi bi-trash"></i> Remove
                                </button>
                            </div>
                        </div>
                    </form>

                    <!-- Continue Button -->
                    <div class="text-end mt-4">
                        <button type="button" class="btn btn-primary btn-lg" id="continueBtn" onclick="proceedToMapping()" 
                                disabled{% if not campaigns %} title="No campaigns available"{% endif %}>
                            <i class="bi bi-arrow-right me-2"></i>Continue to Field Mapping
                        </button>
                        {% if not campaigns %}
                        <div class="form-text text-muted mt-2">
                            <i class="bi bi-info-circle me-1"></i>Create a campaign first to enable target upload
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Step 2: Field Mapping -->
                <div id="mappingStep" class="step-content" style="display: none;">
                    <div class="mapping-section">
                        <h6 class="fw-bold mb-3">
                            <i class="bi bi-arrow-left-right me-2"></i>Map CSV Columns to Target Fields
                        </h6>
                        <p class="text-muted mb-4">
                            Match your CSV columns with the target fields. Email is required, all other fields are optional.
                        </p>

                        <div id="fieldMappings">
                            <!-- Field mappings will be generated dynamically -->
                        </div>
                    </div>

                    <div class="text-end">
                        <button type="button" class="btn btn-outline-secondary me-2" onclick="backToUpload()">
                            <i class="bi bi-arrow-left me-2"></i>Back
                        </button>
                        <button type="button" class="btn btn-primary btn-lg" onclick="proceedToValidation()">
                            <i class="bi bi-arrow-right me-2"></i>Continue to Validation
                        </button>
                    </div>
                </div>

                <!-- Step 3: Preview & Validation -->
                <div id="validationStep" class="step-content" style="display: none;">
                    <h6 class="fw-bold mb-3">
                        <i class="bi bi-check-circle me-2"></i>Validate and Preview Import
                    </h6>

                    <!-- Validation Summary -->
                    <div id="validationSummary" class="mb-4">
                        <!-- Will be populated with validation results -->
                    </div>

                    <!-- Preview Table -->
                    <div class="preview-table">
                        <table class="table table-sm table-striped" id="previewTable">
                            <thead class="table-dark">
                                <tr>
                                    <th>#</th>
                                    <th>Email</th>
                                    <th>First Name</th>
                                    <th>Last Name</th>
                                    <th>Company</th>
                                    <th>Phone</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Preview data will be populated here -->
                            </tbody>
                        </table>
                    </div>

                    <div class="text-end mt-4">
                        <button type="button" class="btn btn-outline-secondary me-2" onclick="backToMapping()">
                            <i class="bi bi-arrow-left me-2"></i>Back to Mapping
                        </button>
                        <button type="button" class="btn btn-success btn-lg" id="importBtn" onclick="importTargets()">
                            <i class="bi bi-check-circle me-2"></i>Import Targets
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Help Section -->
        <div class="card mt-4">
            <div class="card-body">
                <h6 class="card-title">
                    <i class="bi bi-lightbulb text-warning me-2"></i>CSV Upload Guidelines
                </h6>
                <div class="row">
                    <div class="col-md-6">
                        <strong>Required Columns:</strong>
                        <ul class="small">
                            <li><code>email</code> - Valid email address (required)</li>
                            <li>First row should contain column headers</li>
                            <li>UTF-8 encoding recommended</li>
                        </ul>
                        <strong>Optional Columns:</strong>
                        <ul class="small mb-0">
                            <li><code>first_name</code> - Target's first name</li>
                            <li><code>last_name</code> - Target's last name</li>
                            <li><code>company</code> - Company name</li>
                            <li><code>position</code> - Job title/position</li>
                            <li><code>phone</code> - Phone number</li>
                            <li><code>notes</code> - Additional notes</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <strong>CSV Format Example:</strong>
                        <pre class="bg-light p-2 rounded small">email,first_name,last_name,company
john.doe@company.com,John,Doe,Acme Corp
jane.smith@company.com,Jane,Smith,Acme Corp</pre>
                        <strong>Tips:</strong>
                        <ul class="small mb-0">
                            <li>Column names are case-insensitive</li>
                            <li>Duplicates will be detected and skipped</li>
                            <li>Invalid emails will be highlighted</li>
                            <li>Maximum 1000 targets per upload</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Import Progress Modal -->
<div class="modal fade" id="importModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-upload me-2"></i>Importing Targets
                </h5>
            </div>
            <div class="modal-body text-center">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p>Processing your CSV file...</p>
                <div class="progress">
                    <div class="progress-bar" id="importProgress" style="width: 0%"></div>
                </div>
                <small class="text-muted mt-2 d-block" id="importStatus">Preparing import...</small>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
let csvData = [];
let csvHeaders = [];
let fieldMappings = {};

// File upload handling
document.getElementById('csvFile').addEventListener('change', handleFileSelect);

// Drag and drop functionality
const uploadZone = document.getElementById('uploadZone');

uploadZone.addEventListener('dragover', function(e) {
    e.preventDefault();
    this.classList.add('dragover');
});

uploadZone.addEventListener('dragleave', function(e) {
    e.preventDefault();
    this.classList.remove('dragover');
});

uploadZone.addEventListener('drop', function(e) {
    e.preventDefault();
    this.classList.remove('dragover');
    
    const files = e.dataTransfer.files;
    if (files.length > 0) {
        handleFile(files[0]);
    }
});

function handleFileSelect(event) {
    const file = event.target.files[0];
    if (file) {
        handleFile(file);
    }
}

function handleFile(file) {
    // Validate file type
    if (!file.name.toLowerCase().endsWith('.csv') && !file.name.toLowerCase().endsWith('.txt')) {
        showError('Please select a CSV or TXT file');
        return;
    }
    
    // Validate file size (10MB limit)
    if (file.size > 10 * 1024 * 1024) {
        showError('File size must be less than 10MB');
        return;
    }
    
    // Read file
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            parseCSV(e.target.result, file);
        } catch (error) {
            showError('Error reading file: ' + error.message);
        }
    };
    reader.readAsText(file);
}

function parseCSV(csvText, file) {
    // Match backend CSV validation logic from utils/validators.py
    const lines = csvText.split('\n').filter(line => line.trim());
    
    if (lines.length < 2) {
        showError('CSV file must have at least a header row and one data row');
        return;
    }
    
    // Check file size limit (match backend - 5MB)
    const maxFileSize = 5 * 1024 * 1024;
    if (file.size > maxFileSize) {
        showError(`File too large. Maximum size: ${maxFileSize / 1024 / 1024}MB`);
        return;
    }
    
    // Check row count limit (match backend - 10000 rows)
    const maxRows = 10000;
    if (lines.length - 1 > maxRows) {
        showError(`CSV has too many rows. Maximum allowed: ${maxRows}`);
        return;
    }
    
    // Parse headers with proper CSV parsing (handle quoted fields)
    csvHeaders = parseCSVLine(lines[0]);
    
    // Check for required columns
    const requiredColumns = ['email'];
    const missingColumns = requiredColumns.filter(col => 
        !csvHeaders.some(header => header.toLowerCase() === col.toLowerCase())
    );
    
    if (missingColumns.length > 0) {
        showError(`Missing required columns: ${missingColumns.join(', ')}`);
        return;
    }
    
    // Parse data with validation
    csvData = [];
    const errors = [];
    const expectedCols = csvHeaders.length;
    
    for (let i = 1; i < lines.length; i++) {
        const values = parseCSVLine(lines[i]);
        
        // Check column count consistency (match backend validation)
        if (values.length !== expectedCols) {
            errors.push(`Line ${i + 1} has wrong number of columns (expected ${expectedCols}, got ${values.length})`);
            continue;
        }
        
        const row = {};
        csvHeaders.forEach((header, index) => {
            row[header] = values[index] || '';
        });
        csvData.push(row);
    }
    
    if (errors.length > 0) {
        showError(`CSV format errors:\n${errors.slice(0, 5).join('\n')}${errors.length > 5 ? `\n... and ${errors.length - 5} more errors` : ''}`);
        return;
    }
    
    // Show file info
    showFileInfo(file, csvData.length, csvHeaders.length);
    
    // Enable continue button
    document.getElementById('continueBtn').disabled = false;
    
    // Clear any previous errors
    uploadZone.classList.remove('error');
}

function parseCSVLine(line) {
    // Enhanced CSV line parsing to handle quoted fields properly
    const result = [];
    let current = '';
    let inQuotes = false;
    let i = 0;
    
    while (i < line.length) {
        const char = line[i];
        
        if (char === '"') {
            if (inQuotes && line[i + 1] === '"') {
                // Escaped quote
                current += '"';
                i += 2;
            } else {
                // Toggle quote state
                inQuotes = !inQuotes;
                i++;
            }
        } else if (char === ',' && !inQuotes) {
            // End of field
            result.push(current.trim());
            current = '';
            i++;
        } else {
            current += char;
            i++;
        }
    }
    
    // Add last field
    result.push(current.trim());
    
    // Remove surrounding quotes from fields
    return result.map(field => field.replace(/^"(.*)"$/, '$1').trim());
}

function showFileInfo(file, rowCount, columnCount) {
    document.getElementById('fileName').textContent = file.name;
    document.getElementById('fileSize').textContent = formatFileSize(file.size);
    document.getElementById('rowCount').textContent = rowCount;
    document.getElementById('columnCount').textContent = columnCount;
    document.getElementById('fileInfo').style.display = 'block';
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function clearFile() {
    document.getElementById('csvFile').value = '';
    document.getElementById('fileInfo').style.display = 'none';
    document.getElementById('continueBtn').disabled = true;
    csvData = [];
    csvHeaders = [];
}

function showError(message) {
    uploadZone.classList.add('error');
    alert(message); // Replace with better error handling
}

// Step navigation
function proceedToMapping() {
    const campaignSelect = document.getElementById('campaign_id');
    
    if (campaignSelect.disabled) {
        alert('No campaigns available! Please create a campaign first.');
        return;
    }
    
    if (!campaignSelect.value) {
        alert('Please select a campaign first');
        return;
    }
    
    if (csvData.length === 0) {
        alert('Please upload a CSV file first');
        return;
    }
    
    showStep(2);
    generateFieldMappings();
}

function proceedToValidation() {
    if (!validateMappings()) {
        return;
    }
    
    showStep(3);
    validateAndPreview();
}

function backToUpload() {
    showStep(1);
}

function backToMapping() {
    showStep(2);
}

function showStep(stepNumber) {
    // Hide all steps
    document.querySelectorAll('.step-content').forEach(step => {
        step.style.display = 'none';
    });
    
    // Update step indicators
    document.querySelectorAll('.step').forEach((step, index) => {
        step.classList.remove('active', 'completed');
        if (index + 1 < stepNumber) {
            step.classList.add('completed');
        } else if (index + 1 === stepNumber) {
            step.classList.add('active');
        }
    });
    
    // Show current step
    const stepContents = ['uploadStep', 'mappingStep', 'validationStep'];
    document.getElementById(stepContents[stepNumber - 1]).style.display = 'block';
}

function generateFieldMappings() {
    const targetFields = [
        { key: 'email', label: 'Email Address', required: true },
        { key: 'first_name', label: 'First Name', required: false },
        { key: 'last_name', label: 'Last Name', required: false },
        { key: 'company', label: 'Company', required: false },
        { key: 'position', label: 'Position/Title', required: false },
        { key: 'phone', label: 'Phone Number', required: false },
        { key: 'notes', label: 'Notes', required: false }
    ];
    
    let mappingsHTML = '';
    
    targetFields.forEach(field => {
        const suggestedColumn = findBestMatch(field.key, csvHeaders);
        
        mappingsHTML += `
            <div class="field-mapping">
                <div class="row align-items-center">
                    <div class="col-md-4">
                        <label class="form-label fw-bold">
                            ${field.label}
                            ${field.required ? '<span class="text-danger">*</span>' : ''}
                        </label>
                    </div>
                    <div class="col-md-6">
                        <select class="form-select" name="${field.key}" data-field="${field.key}" ${field.required ? 'required' : ''}>
                            <option value="">-- Select Column --</option>
                            ${csvHeaders.map(header => 
                                `<option value="${header}" ${header === suggestedColumn ? 'selected' : ''}>${header}</option>`
                            ).join('')}
                        </select>
                    </div>
                    <div class="col-md-2">
                        ${field.required ? '<span class="badge bg-danger">Required</span>' : '<span class="badge bg-secondary">Optional</span>'}
                    </div>
                </div>
            </div>
        `;
    });
    
    document.getElementById('fieldMappings').innerHTML = mappingsHTML;
}

function findBestMatch(fieldKey, headers) {
    const variations = {
        'email': ['email', 'e-mail', 'mail', 'Email', 'EMAIL'],
        'first_name': ['first_name', 'firstName', 'first name', 'fname', 'First Name'],
        'last_name': ['last_name', 'lastName', 'last name', 'lname', 'Last Name'],
        'company': ['company', 'organization', 'org', 'Company', 'COMPANY'],
        'position': ['position', 'title', 'job title', 'Position', 'Title'],
        'phone': ['phone', 'telephone', 'mobile', 'Phone', 'PHONE'],
        'notes': ['notes', 'comments', 'Notes', 'Comments']
    };
    
    const possibleMatches = variations[fieldKey] || [fieldKey];
    
    for (let match of possibleMatches) {
        if (headers.includes(match)) {
            return match;
        }
    }
    
    return null;
}

function validateMappings() {
    // Get all field mappings
    const mappingSelects = document.querySelectorAll('#fieldMappings select');
    fieldMappings = {};
    
    mappingSelects.forEach(select => {
        if (select.value) {
            fieldMappings[select.dataset.field] = select.value;
        }
    });
    
    // Check if email is mapped
    if (!fieldMappings.email) {
        alert('Email field mapping is required');
        return false;
    }
    
    return true;
}

function validateAndPreview() {
    const validTargets = [];
    const errors = [];
    const warnings = [];
    
    csvData.forEach((row, index) => {
        const target = {};
        const rowErrors = [];
        const rowWarnings = [];
        
        // Map fields
        Object.keys(fieldMappings).forEach(field => {
            const csvColumn = fieldMappings[field];
            let value = row[csvColumn] || '';
            
            // Apply input sanitization (match backend)
            if (value) {
                const originalValue = value;
                value = sanitizeInput(value);
                if (value !== originalValue) {
                    rowWarnings.push(`${field}: Content was sanitized`);
                }
            }
            
            target[field] = value;
        });
        
        // Validate email (match backend validation)
        if (!target.email) {
            rowErrors.push('Missing email');
        } else {
            const emailValidation = validateEmail(target.email);
            if (!emailValidation.valid) {
                rowErrors.push(`Email: ${emailValidation.error}`);
            }
        }
        
        // Validate phone if provided (match backend validation)
        if (target.phone && target.phone.trim()) {
            const phoneValidation = validatePhone(target.phone.trim());
            if (!phoneValidation.valid) {
                rowWarnings.push(`Phone: ${phoneValidation.error}`);
            }
        }
        
        // Check for empty required fields
        if (target.email && target.email.length === 0) {
            rowErrors.push('Email cannot be empty');
        }
        
        // Add row to appropriate category
        if (rowErrors.length === 0) {
            validTargets.push({ ...target, rowNumber: index + 1, warnings: rowWarnings });
        } else {
            errors.push({
                rowNumber: index + 1,
                errors: rowErrors,
                warnings: rowWarnings,
                data: target
            });
        }
        
        // Collect warnings for valid targets too
        if (rowWarnings.length > 0) {
            warnings.push(`Row ${index + 1}: ${rowWarnings.join(', ')}`);
        }
    });
    
    // Show validation summary with enhanced details
    showValidationSummary(validTargets.length, errors, warnings);
    
    // Show preview with error details
    showPreview(validTargets.slice(0, 50), errors.slice(0, 10)); // Show first 50 valid, 10 errors
    
    // Enable/disable import button
    document.getElementById('importBtn').disabled = validTargets.length === 0;
}

function showValidationSummary(validCount, errors, warnings) {
    let summaryHTML = `
        <div class="row">
            <div class="col-md-4">
                <div class="card border-success">
                    <div class="card-body text-center">
                        <h4 class="text-success">${validCount}</h4>
                        <small>Valid Targets</small>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card border-danger">
                    <div class="card-body text-center">
                        <h4 class="text-danger">${errors.length}</h4>
                        <small>Errors</small>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card border-warning">
                    <div class="card-body text-center">
                        <h4 class="text-warning">${warnings.length}</h4>
                        <small>Warnings</small>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    if (errors.length > 0) {
        summaryHTML += `
            <div class="validation-error mt-3">
                <strong>Detailed Errors:</strong>
                <div class="mt-2" style="max-height: 200px; overflow-y: auto;">
                    ${errors.slice(0, 10).map(error => `
                        <div class="mb-2 p-2 border rounded bg-light">
                            <strong>Row ${error.rowNumber}:</strong>
                            <ul class="mb-0 mt-1">
                                ${error.errors.map(err => `<li class="text-danger">${err}</li>`).join('')}
                                ${error.warnings.map(warn => `<li class="text-warning">${warn}</li>`).join('')}
                            </ul>
                            <small class="text-muted">Email: ${error.data.email || 'N/A'}</small>
                        </div>
                    `).join('')}
                    ${errors.length > 10 ? `<div class="text-muted"><small>... and ${errors.length - 10} more errors</small></div>` : ''}
                </div>
            </div>
        `;
    }
    
    if (warnings.length > 0) {
        summaryHTML += `
            <div class="validation-warning mt-3">
                <strong>Warnings:</strong>
                <ul class="mb-0 mt-2">
                    ${warnings.slice(0, 5).map(warning => `<li>${warning}</li>`).join('')}
                    ${warnings.length > 5 ? `<li>... and ${warnings.length - 5} more warnings</li>` : ''}
                </ul>
            </div>
        `;
    }
    
    document.getElementById('validationSummary').innerHTML = summaryHTML;
}

function showPreview(targets, errorRows) {
    const tbody = document.querySelector('#previewTable tbody');
    tbody.innerHTML = '';
    
    // Show valid targets
    targets.forEach(target => {
        const row = document.createElement('tr');
        const hasWarnings = target.warnings && target.warnings.length > 0;
        
        row.innerHTML = `
            <td>${target.rowNumber}</td>
            <td>${target.email}</td>
            <td>${target.first_name || '-'}</td>
            <td>${target.last_name || '-'}</td>
            <td>${target.company || '-'}</td>
            <td>${target.phone || '-'}</td>
            <td>
                <span class="badge ${hasWarnings ? 'bg-warning' : 'bg-success'}">
                    ${hasWarnings ? 'Valid (Warnings)' : 'Valid'}
                </span>
                ${hasWarnings ? `<br><small class="text-muted">${target.warnings.join(', ')}</small>` : ''}
            </td>
        `;
        tbody.appendChild(row);
    });
    
    // Show error rows
    errorRows.forEach(errorRow => {
        const row = document.createElement('tr');
        row.className = 'table-danger';
        
        row.innerHTML = `
            <td>${errorRow.rowNumber}</td>
            <td>${errorRow.data.email || '-'}</td>
            <td>${errorRow.data.first_name || '-'}</td>
            <td>${errorRow.data.last_name || '-'}</td>
            <td>${errorRow.data.company || '-'}</td>
            <td>${errorRow.data.phone || '-'}</td>
            <td>
                <span class="badge bg-danger">Error</span>
                <br><small class="text-danger">${errorRow.errors.join(', ')}</small>
                ${errorRow.warnings.length > 0 ? `<br><small class="text-warning">${errorRow.warnings.join(', ')}</small>` : ''}
            </td>
        `;
        tbody.appendChild(row);
    });
}

function validateEmail(email) {
    // Match backend validation logic from utils/validators.py
    if (!email) {
        return { valid: false, error: "Email address is required" };
    }
    
    // Strip whitespace
    email = email.trim();
    
    // Backend email pattern: r'^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$'
    const emailPattern = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
    
    if (!emailPattern.test(email)) {
        return { valid: false, error: "Invalid email format" };
    }
    
    // Check length limits (match backend)
    if (email.length > 254) {
        return { valid: false, error: "Email address too long" };
    }
    
    // Check local part length (before @)
    const localPart = email.split('@')[0];
    if (localPart.length > 64) {
        return { valid: false, error: "Email local part too long" };
    }
    
    // Check for consecutive dots (match backend)
    if (email.includes('..')) {
        return { valid: false, error: "Email contains consecutive dots" };
    }
    
    // Check that local part doesn't start or end with dot
    if (localPart.startsWith('.') || localPart.endsWith('.')) {
        return { valid: false, error: "Email local part cannot start or end with dot" };
    }
    
    // Check domain part
    const domainPart = email.split('@')[1];
    if (domainPart.startsWith('.') || domainPart.endsWith('.')) {
        return { valid: false, error: "Email domain cannot start or end with dot" };
    }
    
    if (domainPart.includes('..')) {
        return { valid: false, error: "Email domain contains consecutive dots" };
    }
    
    return { valid: true };
}

function validatePhone(phone) {
    // Match backend validation logic from utils/validators.py
    if (!phone) {
        return { valid: false, error: "Phone number is required" };
    }
    
    // Remove spaces and special characters (match backend)
    const cleanPhone = phone.replace(/[^\d+]/g, '');
    
    // International pattern: r'^\+[1-9]\d{1,14}$'
    const internationalPattern = /^\+[1-9]\d{1,14}$/;
    
    // National pattern: r'^0[67]\d{8}$'
    const nationalPattern = /^0[67]\d{8}$/;
    
    if (internationalPattern.test(cleanPhone) || nationalPattern.test(cleanPhone)) {
        return { valid: true };
    } else {
        return { valid: false, error: "Invalid phone number format" };
    }
}

function sanitizeInput(text) {
    // Match backend sanitization logic from utils/helpers.py
    if (!text) {
        return "";
    }
    
    // Remove dangerous characters (match backend)
    text = text.replace(/[<>"']/g, '');
    
    // Limit length (match backend)
    text = text.substring(0, 1000);
    
    return text.trim();
}

function importTargets() {
    const modal = new bootstrap.Modal(document.getElementById('importModal'));
    modal.show();
    
    // Prepare form data
    const formData = new FormData();
    formData.append('campaign_id', document.getElementById('campaign_id').value);
    formData.append('field_mappings', JSON.stringify(fieldMappings));
    formData.append('csv_data', JSON.stringify(csvData));
    formData.append('skip_duplicates', 'on'); // Default to skip duplicates
    
    // Add actual CSV file data for backend processing
    const csvContent = generateCSVFromMappedData();
    const csvBlob = new Blob([csvContent], { type: 'text/csv' });
    formData.append('csv_file', csvBlob, 'upload.csv');
    
    // Make the actual API call to import the targets
    fetch('/admin/targets/upload', {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'  // Indicate this is an AJAX request
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        modal.hide();
        if (data.success) {
            // Show detailed success message with statistics
            let message = data.message || 'Targets imported successfully!';
            if (data.stats) {
                message += `\n\nResults:`;
                message += `\n✅ Added: ${data.stats.added}`;
                if (data.stats.skipped > 0) {
                    message += `\n⚠️ Skipped: ${data.stats.skipped} (duplicates)`;
                }
                if (data.stats.errors > 0) {
                    message += `\n❌ Errors: ${data.stats.errors}`;
                    
                    // Show detailed error information
                    if (data.stats.error_details && data.stats.error_details.length > 0) {
                        message += `\n\nError Details:`;
                        data.stats.error_details.slice(0, 5).forEach(error => {
                            message += `\n• ${error}`;
                        });
                        if (data.stats.error_details.length > 5) {
                            message += `\n• ... and ${data.stats.error_details.length - 5} more errors`;
                        }
                    }
                }
            }
            
            // Show enhanced message with better formatting
            if (data.stats && data.stats.errors > 0) {
                // If there were errors, show a detailed modal instead of simple alert
                showImportResultsModal(data);
            } else {
                alert(message);
                // Redirect to targets list only if no errors
                window.location.href = "{{ url_for('targets.list_targets') }}";
            }
        } else {
            let errorMsg = data.error || 'Error importing targets';
            if (data.details) {
                errorMsg += `\nDetails: ${data.details}`;
            }
            if (data.stats && data.stats.error_details) {
                errorMsg += `\n\nError Details:`;
                data.stats.error_details.slice(0, 5).forEach(error => {
                    errorMsg += `\n• ${error}`;
                });
            }
            alert(errorMsg);
        }
    })
    .catch(error => {
        modal.hide();
        console.error('Import error:', error);
        alert('Error importing targets: ' + error.message);
    });
}

function showImportResultsModal(data) {
    // Create a detailed results modal
    const modalHTML = `
        <div class="modal fade" id="importResultsModal" tabindex="-1" data-bs-backdrop="static">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="bi bi-upload me-2"></i>Import Results
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <div class="card border-success text-center">
                                    <div class="card-body">
                                        <h4 class="text-success">${data.stats.added}</h4>
                                        <small>Successfully Added</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card border-warning text-center">
                                    <div class="card-body">
                                        <h4 class="text-warning">${data.stats.skipped}</h4>
                                        <small>Skipped (Duplicates)</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card border-danger text-center">
                                    <div class="card-body">
                                        <h4 class="text-danger">${data.stats.errors}</h4>
                                        <small>Errors</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        ${data.stats.error_details && data.stats.error_details.length > 0 ? `
                            <div class="alert alert-danger">
                                <h6><i class="bi bi-exclamation-triangle me-2"></i>Error Details:</h6>
                                <div style="max-height: 200px; overflow-y: auto;">
                                    ${data.stats.error_details.map(error => `
                                        <div class="mb-1"><small>• ${error}</small></div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                        
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle me-2"></i>
                            <strong>What's next?</strong><br>
                            ${data.stats.added > 0 ? 
                                `${data.stats.added} targets were successfully added to the campaign. ` : ''
                            }
                            ${data.stats.errors > 0 ? 
                                'Please fix the errors in your CSV file and try uploading again for the failed rows.' : 
                                'You can now proceed to manage your targets or start the campaign.'
                            }
                        </div>
                    </div>
                    <div class="modal-footer">
                        ${data.stats.errors > 0 ? `
                            <button type="button" class="btn btn-secondary" onclick="backToMapping()">
                                <i class="bi bi-arrow-left me-2"></i>Fix CSV & Try Again
                            </button>
                        ` : ''}
                        <button type="button" class="btn btn-primary" onclick="window.location.href='{{ url_for('targets.list_targets') }}'">
                            <i class="bi bi-list me-2"></i>View Targets
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal if any
    const existingModal = document.getElementById('importResultsModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Add new modal to DOM
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    // Show the modal
    const resultsModal = new bootstrap.Modal(document.getElementById('importResultsModal'));
    resultsModal.show();
}

function generateCSVFromMappedData() {
    // Generate CSV content from mapped data
    if (!fieldMappings.email) {
        throw new Error('Email mapping is required');
    }
    
    // Create header row with mapped fields
    const headers = Object.keys(fieldMappings).map(field => fieldMappings[field]);
    let csvContent = headers.join(',') + '\n';
    
    // Add data rows
    csvData.forEach(row => {
        const values = Object.keys(fieldMappings).map(field => {
            const csvColumn = fieldMappings[field];
            const value = row[csvColumn] || '';
            // Escape commas and quotes in CSV
            if (value.includes(',') || value.includes('"') || value.includes('\n')) {
                return '"' + value.replace(/"/g, '""') + '"';
            }
            return value;
        });
        csvContent += values.join(',') + '\n';
    });
    
    return csvContent;
}
</script>
{% endblock %}